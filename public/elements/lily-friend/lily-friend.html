<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/core-animated-pages/transitions/slide-down.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../lily-editor/lily-editor.html">
<link rel="import" href="../lily-preview/lily-preview.html">
<polymer-element name="lily-friend">

    <template>
        <style>
            .half {
                padding: 1em;
                width: 50%;
                position: relative;
            }

            .header {
                background-color: #3f51b5;
                color: white;
                z-index: 1;
            }

            .container {
                overflow-y: auto;
            }

            #log {
                position: absolute;
                background-color: #C5CAE9;
                z-index: 1;
            }

            #log div {
                overflow-y: auto;
                height: 100%;
            }

            pre {
                margin: 0;
            }

            .loading {
                position: absolute;
                top: 20px;
                right: 20px;
                border-radius: 50%;
                height: 50px;
                width: 50px;
                background-color: white;
            }
        </style>
        <div horizontal layout fit>
            <div class="half left" vertical layout>
                <div horizontal layout end-justified class="header">
                    <paper-icon-button mini icon="send" on-tap="{{send}}"
                                       disabled?="{{converting}}"></paper-icon-button>
                </div>
                <div flex class="container">
                    <lily-editor source="{{source}}" flex></lily-editor>
                </div>
            </div>
            <div class="half" vertical layout>
                <div horizontal layout center-justified class="header">
                    <paper-icon-button mini icon="description" disabled?="{{converting || error}}"
                                       on-tap="{{toggle}}"></paper-icon-button>
                    <paper-icon-button mini icon="archive" disabled?="{{converting || error}}"></paper-icon-button>
                </div>
                <div flex style="position: relative">
                    <paper-shadow z="1" id="log" hidden?="{{!outVisible}}" fit>
                        <div style="overflow-y: auto;" id="logContainer">
                            <template repeat="{{line in out}}">
                                <pre>{{line}}</pre>
                            </template>
                        </div>
                        <template if="{{converting}}">
                            <paper-shadow z="1" class="loading" horizontal layout center-center>
                                <paper-spinner active></paper-spinner>
                            </paper-shadow>
                        </template>
                    </paper-shadow>
                    <template if="{{!converting}}">
                        <div class="container" fit>
                            <lily-preview source="{{path}}" converting="{{converting}}"></lily-preview>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            source: '',
            ready: function () {
                this.ws = new WebSocket('ws://' + window.location.host + '/convert');
                var self = this;
                this.ws.onmessage = function (response) {
                    var msg = JSON.parse(response.data);
                    switch (msg.type) {
                        case 'output':
                            self.out.push(msg.out);
                            self.async(function () {
                                self.$.logContainer.scrollTop = self.$.logContainer.scrollHeight;
                            });
                            break;
                        case 'error':
                        case 'fail':
                            self.errored(msg);
                            break;
                        case 'success':
                            self.success(msg);
                            break;
                        default :
                            console.log(msg);
                            break;
                    }
                };
            },
            computed: {
                'outVisible': 'error || _outVisible'
            },
            toggle: function () {
                this._outVisible = !this._outVisible;
            },
            send: function () {
                this.ws.send(this.source || '');
                this.converting = true;
                this._outVisible = true;
                this.out = [];
                this.error = false;
            },
            success: function (msg) {
                this.path = msg.dir;
                this.error = false;
                this.converting = false;
                this._outVisible = false;
            },
            errored: function (msg) {
                this.error = true;
                this.path = undefined;
                this.converting = false;
            }
        });
    </script>
</polymer-element>


