<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<dom-module id="lily-friend">
    <style>
        .out {
            @apply(--layout-horizontal);
            @apply(--layout-fit);
        }
        .half {
            padding: 1em;
            width: 50%;
            position: relative;
        }
        .left .header {
            @apply(--layout-horizontal);
            @apply(--layout-end-justified);
        }

        .header {
            background-color: #3f51b5;
            color: white;
            z-index: 1;
        }

        .container {
            overflow-y: auto;
        }

        #log {
            position: absolute;
            background-color: #C5CAE9;
            z-index: 1;
        }

        #log div {
            overflow-y: auto;
            height: 100%;
        }

        pre {
            margin: 0;
        }

        .loading {
            position: absolute;
            top: 20px;
            right: 20px;
            border-radius: 50%;
            height: 50px;
            width: 50px;
            background-color: white;
        }

        #audio {
            position: absolute;
            right: 0;
            top: 46px;
        }

        #audioHeader {
            @apply(--layout-horizontal);
            @apply(--layout-center);
            position: relative;
        }
        .button-set {
            @apply(--layout-horizontal);
            @apply(--layout-center);
        }
    </style>
    <template>
        <iron-localstorage name="lily-friend-source" value="{{source}}"></iron-localstorage>
        <div class="out">
            <div class="half left">
                <div class="header">
                    <paper-icon-button mini icon="send" on-tap="send"
                                       disabled$="{{converting}}"></paper-icon-button>
                </div>
                <div class="container">
                    <lily-editor source="{{source}}" id="editor"></lily-editor>
                </div>
            </div>
            <div class="half">
                <div class="header" id="audioHeader">
                    <div class="button-set">
                        <paper-icon-button mini icon="description" disabled$="{{converting || error}}"
                                           on-tap="toggle"></paper-icon-button>
                        <paper-icon-button mini icon="archive" disabled$="{{converting || error}}"></paper-icon-button>
                        <paper-icon-button mini icon="social:share" disabled$="{{converting || error}}"></paper-icon-button>
                    </div>
                    <template if="{{audio}}">
                        <div flex horizontal layout center end-justified>
                            <core-icon icon="error" hidden$="{{!audioError}}"></core-icon>
                            <paper-spinner active hidden$="{{audioReady || audioError}}"></paper-spinner>
                            <paper-icon-button mini icon="hardware:headset" disabled$={{!audioReady}}
                                               on-tap="toggleAudio"></paper-icon-button>
                        </div>
                    </template>
                    <audio controls id="audio" hidden$="[[!audioVisible]]">
                    </audio>
                </div>
                <div flex style="position: relative">
                    <paper-shadow z="1" id="log" hidden$="{{!outVisible}}" fit>
                        <div style="overflow-y: auto;" id="logContainer">
                            <template repeat="{{line in out}}">
                                <pre>{{line}}</pre>
                            </template>
                        </div>
                        <template if="{{converting}}">
                            <paper-shadow z="1" class="loading" horizontal layout center-center>
                                <paper-spinner active></paper-spinner>
                            </paper-shadow>
                        </template>
                    </paper-shadow>
                    <template if="{{!converting}}">
                        <div class="container" fit>
                            <lily-preview path="{{path}}" pages="{{pages}}" converting="{{converting}}"></lily-preview>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </template>

    <script src="../../bower_components/reconnectingWebsocket/reconnecting-websocket.min.js"></script>
    <script>
        Polymer({
            is: "lily-friend",
            source: '\\version "2.18.2"\n',
            audioReady: false,
            ready: function () {
                this.ws = new ReconnectingWebSocket('ws://' + window.location.host + '/convert');
                var self = this;
                this.ws.onmessage = function (response) {
                    var msg = JSON.parse(response.data);
                    switch (msg.type) {
                        case 'output':
                            self.out.push(msg.out);
                            self.async(function () {
                                self.$.logContainer.scrollTop = self.$.logContainer.scrollHeight;
                            });
                            break;
                        case 'error':
                        case 'fail':
                            self.errored(msg);
                            break;
                        case 'success':
                            self.success(msg);
                            break;
                        case 'audio start':
                            self.audio = true;
                            break;
                        case 'audio success':
                            self.audioSuccess();
                            break;
                        case 'audio fail':
                            self.audioFail();
                            break;
                        default :
                            console.log(msg);
                            break;
                    }
                };
            },
            computed: {
                'outVisible': 'error || _outVisible',
                'audioVisible': 'audioReady && _audioVisible'
            },
            toggle: function () {
                this._outVisible = !this._outVisible;
            },
            toggleAudio: function () {
                this._audioVisible = !this._audioVisible;
            },
            send: function () {
                this.ws.send(this.source || '');
                this.converting = true;
                this._outVisible = true;
                this.out = [];
                this.error = false;
                this.audio = false;
                this.audioReady = false;
                this.audioError = false;
            },
            success: function (msg) {
                this.path = msg.dir;
                this.pages = msg.pages;
                this.error = false;
                this.converting = false;
                this._outVisible = false;
            },
            errored: function (msg) {
                this.error = true;
                this.path = undefined;
                this.converting = false;
            },
            audioSuccess: function () {
                this.audioReady = true;
                this.$.audio.setAttribute("src", "/audios?path=" + encodeURI(this.path));
            },
            audioFail: function(){
                this.audioError = true;
            }
        });
    </script>

</dom-module>